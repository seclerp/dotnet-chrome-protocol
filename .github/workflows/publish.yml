name: Publish

on: workflow_dispatch

defaults:
  run:
    working-directory: src

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: üìù Fetch Sources
        uses: actions/checkout@v4
      - name: üõ† Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: üèó Restore dependencies
        run: dotnet restore
      - name: üèó Build
        run: dotnet build --no-restore --configuration Release
      - name: üîç Extract Version
        id: version
        run: |
          echo "RELEASE_VERSION=$(dotnet msbuild Directory.Build.props -getProperty:Version)" >> $GITHUB_ENV
      - name: üîç Extract Changelog
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2
        with:
          validation_level: warn
          version: ${{ env.RELEASE_VERSION }}
          path: ./CHANGELOG.md
      - name: üöÄ Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          name: ${{ env.RELEASE_VERSION }}
          draft: true
          prerelease: false
          generate_release_notes: false
          body: |
            ${{ steps.changelog_reader.outputs.changes }}

            Changelog file can be found [here](./CHANGELOG.md).
            
            NuGet links:
              - [ChromeProtocol.Runtime](https://www.nuget.org/packages/ChromeProtocol.Runtime)
              - [ChromeProtocol.Domains](https://www.nuget.org/packages/ChromeProtocol.Domains)
              - [ChromeProtocol.Core](https://www.nuget.org/packages/ChromeProtocol.Core)
      - name: üöÄ Publish
        run: dotnet nuget push "**/*.nupkg" --api-key "$NUGET_API_KEY" --source https://api.nuget.org/v3/index.json --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }} 
